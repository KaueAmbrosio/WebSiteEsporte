name: Atualizar matches diário

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-matches:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Buscar próximos eventos da liga (TheSportsDB)
        env:
          APIKEY: 1
          LEAGUE_ID: 4328
        run: |
          set -e
          echo "Buscando dados TheSportsDB..."
          curl -s "https://www.thesportsdb.com/api/v1/json/${APIKEY}/eventsnextleague.php?id=${LEAGUE_ID}" -o raw_events.json

          if [ "$(jq -r '.events // empty | length' raw_events.json)" = "" ]; then
            echo "Nenhum evento retornado."
            cat raw_events.json
            exit 1
          fi

          mkdir -p assets/data

          cat raw_events.json | jq -r '
            .events // [] |
            map({
              id: .idEvent,
              homeTeam: .strHomeTeam,
              awayTeam: .strAwayTeam,
              homeScore: (if (.intHomeScore == null) then null else (.intHomeScore | tonumber) end),
              awayScore: (if (.intAwayScore == null) then null else (.intAwayScore | tonumber) end),
              status: ( .strStatus // (.strTime // "Agendado") ),
              date: ( (.dateEvent // "") + "T" + ( (.strTime // "00:00:00") ) ),
              stadium: (.strVenue // ""),
              referee: (.strReferee // ""),
              events: []
            })' > assets/data/matches.json

          echo "Arquivo gerado com $(jq '. | length' assets/data/matches.json) partidas."

      - name: Commitar e push das mudanças (se houver)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add assets/data/matches.json
          git commit -m "Atualiza matches.json via TheSportsDB - $(date -u +'%Y-%m-%d')" || echo "Sem mudanças"
          git push
