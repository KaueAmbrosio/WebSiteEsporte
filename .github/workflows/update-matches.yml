name: Atualizar matches diario

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-matches:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Buscar jogos TheSportsDB v1
        run: |
          set -e
          APIKEY=123
          LEAGUE_ID=4328
          mkdir -p assets/data

          URL="https://www.thesportsdb.com/api/v1/json/${APIKEY}/eventsseason.php?id=${LEAGUE_ID}"
          echo "Consultando $URL"

          if curl -f -s "$URL" -o raw.json; then
            if jq -e '.events != null' raw.json >/dev/null; then
              jq '.events | map({
                id: .idEvent,
                homeTeam: .strHomeTeam,
                awayTeam: .strAwayTeam,
                homeScore: .intHomeScore,
                awayScore: .intAwayScore,
                status: (.strStatus // "Agendado"),
                date: ((.dateEvent // "") + "T" + (.strTime // "00:00:00")),
                stadium: (.strVenue // ""),
                referee: (.strReferee // ""),
                events: []
              })' raw.json > assets/data/matches.json
            else
              echo "[]" > assets/data/matches.json
            fi
          else
            echo "[]" > assets/data/matches.json
          fi

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add assets/data/matches.json
          git commit -m "Atualiza matches" || echo "Sem mudan√ßas"
          git push