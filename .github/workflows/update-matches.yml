name: Atualizar matches diario

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-matches:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Buscar dados TheSportsDB
        run: |
          set -e
          APIKEY=1
          LEAGUE_ID=4328
          mkdir -p assets/data

          echo "Tentando v1 next..."
          if curl -f -s "https://www.thesportsdb.com/api/v1/json/${APIKEY}/eventsnextleague.php?id=${LEAGUE_ID}" -o raw.json; then
            if jq -e '.events != null' raw.json >/dev/null; then
              echo "Dados encontrados"
              jq '.events | map({
                id: .idEvent,
                homeTeam: .strHomeTeam,
                awayTeam: .strAwayTeam,
                homeScore: .intHomeScore,
                awayScore: .intAwayScore,
                status: (.strStatus // "Agendado"),
                date: ((.dateEvent // "") + "T" + (.strTime // "00:00:00")),
                stadium: (.strVenue // ""),
                referee: (.strReferee // ""),
                events: []
              })' raw.json > assets/data/matches.json
            else
              echo "Sem eventos, criando vazio"
              echo "[]" > assets/data/matches.json
            fi
          else
            echo "API falhou, criando vazio"
            echo "[]" > assets/data/matches.json
          fi

      - name: Commit e push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add assets/data/matches.json
          git commit -m "update matches" || echo "sem mudancas"
          git push
