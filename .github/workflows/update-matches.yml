name: Atualizar matches diario

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  update-matches:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Buscar dados TheSportsDB
        run: |
          set -e
          APIKEY=1
          LEAGUE_ID=4328
          mkdir -p assets/data

          echo "Tentando v2 last..."
          if curl -f -s "https://www.thesportsdb.com/api/v2/json/${APIKEY}/events/last/${LEAGUE_ID}" -o raw.json; then
            if jq -e '.events != null' raw.json >/dev/null; then
              echo "Dados encontrados"
              jq '.events | map({
                id: .idEvent,
                homeTeam: (.strHome // .strHomeTeam),
                awayTeam: (.strAway // .strAwayTeam),
                homeScore: (.intHomeScore | tonumber?),
                awayScore: (.intAwayScore | tonumber?),
                status: (.strStatus // "Finalizado"),
                date: ((.dateEvent // .date // "") + "T" + (.strTime // .time // "00:00:00")),
                stadium: (.strVenue // ""),
                referee: (.strReferee // ""),
                events: []
              })' raw.json > assets/data/matches.json
            else
              echo "Sem eventos"
              echo "[]" > assets/data/matches.json
            fi
          else
            echo "API falhou"
            echo "[]" > assets/data/matches.json
          fi

      - name: Commit e push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add assets/data/matches.json
          git commit -m "Atualiza matches $(date -u +'%Y-%m-%d')" || echo "Sem mudan√ßas"
          git push
